{% extends "base.html" %}
{#{% load my_templatetags %}#}
{% block contenido %}
    <input type="hidden" value="{{ ginput.gform.id }}" name="gform" id="gform">
    <input type="hidden" value="{{ ginput.id }}" name="ginput" id="ginput">
    <div class="row">
        <div class="columns large-12">
            <label>Selecciona los cargos/perfiles que pueden rellenar este campo:
                <div class="columns large-12">
                    <select id="cargos_permitidos" name="cargos_permitidos" multiple>
                        {% for cargo in cargos %}
                            <option value="{{ cargo.id }}"
                                    {% if cargo in ginput.cargos_permitidos.all %}selected{% endif %}>
                                {{ cargo.cargo }}</option>
                        {% endfor %}
                    </select>
                </div>
            </label>
        </div>
    </div>
    <div class="row">
        <div class="columns large-9">
            <label>Escribe el texto que etiqueta el campo:</label>
            <input type="text" name="label" id="label" value="{{ ginput.label }}" data-id="{{ ginput.id }}">

        </div>
        {% if ginput.tipo == 'gselect' %}
            <div class="columns large-3">
                <label>¿Se pueden seleccionar varias opciones?
                    <a id="ginput_multiple" data-id="{{ ginput.id }}">
                        {% if ginput.select %}Sí{% else %}No{% endif %}</a>
                </label>
            </div>
        {% endif %}
    </div>
    {% if ginput.tipo == 'gselect' %}
        <div id="goptions">{% include "edita_goption.html" %}</div>
        <div class="row">
            <div class="columns large-12 center">
                <a id="add_goption" class="button radius"><i class="fa fa-plus"></i> Añadir una nueva opción</a>
            </div>
        </div>

    {% endif %}


{% endblock %}


{% block final %}
    <script type="text/javascript">
        habilita(['s_arrow-left', 's_trash-o']);

        $('#arrow-left_sign').on('click', function (e) {
            e.preventDefault();
            var gform = $('#gform').val();
            window.location.href = "/edita_gform/?gform=" + gform;
        });

        $('#trash-o_sign').on('click', function (e) {
            e.preventDefault();
            var gform = $('#gform').val();
            var id = $('#ginput').val();
            $.post("/formulario_ajax/", {action: 'del_ginput', id: id}, function (data) {
                window.location.href = "/edita_gform/?gform=" + gform;
            });
        });

        $('#cargos_permitidos').select2({placeholder: "Si no seleccionas ninguno, todos tendrán acceso"});
        $('#cargos_permitidos').on('change', function (e) {
            var id = $('#ginput').val();
            var seleccionados = [];
            $('#cargos_permitidos option').each(function (i) {
                if (this.selected == true) {
                    seleccionados.push(this.value);
                }
            });
            seleccionados = JSON.stringify(seleccionados);
            $.post("/formulario_ajax/", {action: 'mod_cargos_permitidos', seleccionados: seleccionados, id: id},
                    function (data) {
                        console.log(data);
                    });
        });

        $('#label').on('input', function (e) {
            var id = $(this).data('id');
            var label = $(this).val();
            $.post("/formulario_ajax/", {action: 'mod_ginput_label', label: label, id: id}, function (data) {
                console.log(data);
            });
        });
        $('#ginput_multiple').on('click', function (e) {
            e.preventDefault();
            var id = $(this).data('id');
            $.post("/formulario_ajax/", {action: 'mod_ginput_multiple', id: id}, function (data) {
                console.log(data);
                $('#ginput_multiple').html(data);
            });
        });
        $('body').on('input', '.opciones_texto', function (e) {
            var id = $(this).data('id');
            var text = $(this).val();
            $.post("/formulario_ajax/", {action: 'mod_goption_text', text: text, id: id}, function (data) {
                console.log(data);
            });
        });
        $('body').on('input', '.opciones_valor', function (e) {
            var id = $(this).data('id');
            var value = $(this).val();
            $.post("/formulario_ajax/", {action: 'mod_goption_value', value: value, id: id}, function (data) {
                console.log(data);
            });
        });
        $('body').on('click', '.del_goption', function (e) {
            e.preventDefault();
            var id = $(this).data('id');
            $.post("/formulario_ajax/", {action: 'del_goption', id: id}, function (data) {
                $('#goptions').html(data);
            });
        });
        $('#add_goption').on('click', function (e) {
            e.preventDefault();
            var id = $('#ginput').val();
            $.post("/formulario_ajax/", {action: 'add_goption', id: id}, function (data) {
                $('#goptions').html(data);
            });
        });

    </script>

{% endblock %}