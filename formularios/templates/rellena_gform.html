{% extends "base.html" %}
{% load my_templatetags %}
{% load tz %}
{% block head %}
    <style>
        .check_w {
            color: red;
            display: none;
        }
    </style>
{% endblock %}
{% block contenido %}
    <form action="" method="post" enctype="multipart/form-data" id="{{ formname }}" name="{{ formname }}"
          xmlns="http://www.w3.org/1999/html">
        {% csrf_token %}
        <input type="hidden" name="action" id="action" value="">
        <input type="hidden" name="ge" id="ge" value="{{ ge.id }}">
        <input type="hidden" name="id_gform" id="id_gform" value="{{ gform.id }}">
        <input type="hidden" name="id_ginput" id="id_ginput" value="">

        <div class="">
            <h4 style="text-align: center;color: #008CBA;"><strong>{{ ginputs.0.gform.nombre }}</strong>
                {% if ge != request.session.gauser_extra %}
                    ({{ ge.gauser.get_full_name }}){% endif %}</h4>
        </div>
        {% if request.session.aviso_rellenar_gform != 1 %}
            <div data-alert class="alert-box success radius">
                GAUSS grabará las respuestas a medida que las vayas escribiendo. Podrás ver un símbolo,
                <i style="color: red;" class="fa fa-check"></i> cada vez que se haga una grabación automática.
                <a href="#" class="close">&times;</a>
            </div>
        {% endif %}
        {% for ginput in ginputs %}
            {% ifchanged ginput.ginput.row %}
                {% if not forloop.first %}
                    </div>
                {% endif %}
                <div class="row">
                <div class="columns large-{{ ginput.ginput.ancho }}">
            {% else %}
                <div class="columns large-{{ ginput.ginput.ancho }}">
            {% endifchanged %}
        {% if ginput.tipo == 'gselect' %}
            <span>{{ ginput.ginput.label }} <i id="check{{ ginput.id }}" class="fa fa-check check_w"></i></span>
            <select name="ginput{{ ginput.id }}" id="ginput{{ ginput.id }}" data-id="{{ ginput.id }}"
                    {% if ginput.ginput.select %}multiple{% endif %} class="gselect">
                {% for goption in ginput.goption_set.all reversed %}
                    <option value="{{ goption.id }}" {# El valor es el id, para identificar el goption #}
                            {% if goption.selected %}selected{% endif %}>{{ goption.text }}
                    </option>
                {% endfor %}
            </select>
        {% elif ginput.tipo == 'gbool' %}
            <span>{{ ginput.ginput.label }} <i id="check{{ ginput.id }}" class="fa fa-check check_w"></i></span>
            <br><input type="checkbox" data-id="{{ ginput.id }}" class="gbool" id="ginput{{ ginput.id }}"
                       {% if ginput.gbool %}checked{% endif %}>
        {% elif ginput.tipo == 'gtext' %}
            <span>{{ ginput.ginput.label }} <i id="check{{ ginput.id }}" class="fa fa-check check_w"></i></span>
            <textarea rows="4" class="ginput" data-tipo="{{ ginput.tipo }}" data-id="{{ ginput.id }}"
            >{% if ginput.gtext %}{{ ginput.gtext }}{% endif %}</textarea>
        {% elif ginput.tipo == 'gfile' %}
            <span>{{ ginput.ginput.label }}  <i id="check{{ ginput.id }}" class="fa fa-check check_w"></i></span><br>
            <a class="a_gfile" data-id="{{ ginput.id }}" id="a_ginput{{ ginput.id }}">
                {% if ginput.archivo %}
                    {{ ginput.fich_name }}
                {% else %}
                    Click aquí para cargar un archivo
                {% endif %}</a>
            <a class="t_gfile button tiny round" id="t_ginput{{ ginput.id }}" data-id="{{ ginput.id }}"
               style="display: {% if ginput.archivo %}inline;{% else %}none;{% endif %}"> <i
                    class="fa fa-trash-o fa-2x"></i></a>
            <input type="file" class="gfile" id="ginput{{ ginput.id }}" style="position: fixed; top: -3000px;"
                   data-id="{{ ginput.id }}" name="ginput{{ ginput.id }}">
        {% elif ginput.tipo == 'gdatetime' %}
            <span>{{ ginput.ginput.label }} <i id="check{{ ginput.id }}" class="fa fa-check check_w"></i></span>
            <input type="text" class="ginput" data-tipo="{{ ginput.tipo }}" data-id="{{ ginput.id }}"
                   placeholder="{{ ginput.get_tipo_display }}"
                   value="{% if ginput.gdatetime %}{{ ginput.gdatetime|date:'d/m/Y H:i' }}{% endif %}">
        {% elif ginput.tipo == 'gdate' %}
            <span>{{ ginput.ginput.label }} <i id="check{{ ginput.id }}" class="fa fa-check check_w"></i></span>
            <input type="text" class="ginput" data-tipo="{{ ginput.tipo }}" data-id="{{ ginput.id }}"
                   placeholder="{{ ginput.get_tipo_display }}"
                   value="{% if ginput.gdate %}{{ ginput.gdate|date:'d/m/Y' }}{% endif %}">
        {% else %}
            <span>{{ ginput.ginput.label }} <i id="check{{ ginput.id }}" class="fa fa-check check_w"></i></span>
            <input type="text" class="ginput" data-tipo="{{ ginput.tipo }}" data-id="{{ ginput.id }}"
                   placeholder="{{ ginput.get_tipo_display }}" value="{{ ginput|gvalor }}">
        {% endif %}
        </div>
        {% if forloop.last %}
            </div>
        {% endif %}
        {% endfor %}


    </form>


{% endblock %}


{% block final %}

    <script type="text/javascript">
        {#        habilita(['s_check']);#}
        $('.gselect').select2();

        $(document).on('close.fndtn.alert', function (event) {
            $.post("/formulario_ajax/", {action: 'del_alert'}, function (data) {
                console.log(data);
            });
        });

        {# Grabar los ginputs rellenados en el momento de ser rellenados #}
        function isFloat(n) {
            return n === +n && n !== (n | 0);
        }

        function isInteger(n) {
            return n === +n && n === (n | 0);
        }

        $('.a_gfile').on('click', function (e) {
            e.preventDefault();
            var id = $(this).data('id');
            $('#ginput' + id).trigger('click');
        });

        $('.gfile').change(function (e) {
            var id = $(this).attr('id');
            var a_id = 'a_' + id;
            var t_id = 't_' + id;
            {#            var input_file = document.getElementById(id).value;#}
            var input_file = $('#' + id).val();
            $('#' + a_id).html(input_file);
            $('#' + t_id).show();

            $('#action').val('save_gfile');
            $('#id_ginput').val($(this).data('id'));
            var form = $('form')[0]; // You need to use standart javascript object here
            var formData = new FormData(form);
            $.ajax({
                url: '/formulario_ajax/',
                data: formData,
                type: 'post',
                // THIS MUST BE DONE FOR FILE UPLOADING
                contentType: false,
                processData: false
                // ... Other options like success and etc
            });
            $("#check" + $(this).data('id')).show().delay(1500).fadeOut();
        });

        $('body').on('click', '.t_gfile', function (e) {
            e.preventDefault();
            var id = $(this).data('id');
            $.post("/formulario_ajax/", {action: 'delete_gfile', id: id, ge: $('#ge').val()}, function (data) {
                if (data != 'True') {
                    show_mensajes({title: "<i class='fa fa-warning'></i> Error", texto: data});
                } else {
                    console.log(data);
                    $('#' + 'a_ginput' + id).html('Click aquí para cargar un archivo');
                    $('#' + 't_ginput' + id).hide();
                    $("#check" + id).show().delay(1500).fadeOut();
                }
            });
        });

        $('.ginput').on('input', function (e) {
            var id = $(this).data('id');
            var valor = $(this).val();
            var tipo = $(this).data('tipo');
            console.log(tipo);
            if ((tipo != 'gdate' && tipo != 'gdatetime') || (valor.length > 9 && tipo != 'gdatetime') || (tipo != 'gdate' && valor.length > 15)) {
                $.post("/formulario_ajax/", {
                    action: 'save_' + tipo,
                    valor: valor,
                    id: id,
                    ge: $('#ge').val()
                }, function (data) {
                    if (data != 'True') {
                        show_mensajes({title: "<i class='fa fa-warning'></i> Error", texto: data});
                    } else {
                        console.log(data);
                        $("#check" + id).show().delay(1500).fadeOut();
                    }
                });
            }
        });

        $('.gbool').on('change', function (e) {
            var id = $(this).data('id');
            $.post("/formulario_ajax/", {action: 'save_gbool', id: id, ge: $('#ge').val()}, function (data) {
                if (data != 'True') {
                    $('#ginput' + id).html(data);
                } else {
                    console.log(data);
                    $("#check" + id).show().delay(1500).fadeOut();
                }
            });
        });

        $('.gselect').on('change', function (e) {
            var id = $(this).data('id');
            var val = $("#myOptions option:selected").data('id');
            var selected = JSON.stringify(e.val);
            console.log(selected);
            $.post("/formulario_ajax/", {
                action: 'save_goption',
                selected: selected,
                id: id,
                ge: $('#ge').val()
            }, function (data) {
                if (data != 'True') {
                    show_mensajes({title: "<i class='fa fa-warning'></i> Error", texto: data});
                } else {
                    console.log(data);
                    $("#check" + id).show().delay(1500).fadeOut();
                }
            });
        });

    </script>

{% endblock %}