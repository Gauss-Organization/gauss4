{% extends "base_select2-4.html" %}
{% load my_templatetags %}

{% block head %}
    <style>
        #div_documento {
            position: relative;
            display: none;
            background-color: #ffffff;
            border: solid 1px #d3d3d3;
            padding: 10px;
            margin-top: 10px;
        }

        input[name="documentos"] {
            display: none;
        }
    </style>
{% endblock %}


{% block contenido %}
    <form action="" method="post" enctype="multipart/form-data" id="{{ formname }}" name="{{ formname }}">
        {% csrf_token %}
        <input type="hidden" id="action" name="action" value="">
        <input type="hidden" id="documento" name="documento" value="">


        <h4 style="text-align: center;color: #008CBA;">
            <strong> Documentos almacenados en la entidad</strong>
        </h4>

        <div id="div_fieldsets"></div>

        <div id="div_documentos">
            {% include 'documentos_table.html' %}
        </div>
        <div id="form_documento" style="display: none;">
        </div>
        <div id="observaciones_documento"
             style="display: none;position: relative;border: solid 1px #d3d3d3; margin-top: 10px;padding: 5px;">
        </div>

        {% if request.session.gauser_extra|has_cargos:'1,2' %}
            <div id="mensaje_crear_carpeta" class="reveal-modal medium" data-reveal>
                <h5>Nombre de carpeta a crear:</h5>
                <input type="text" name="nombre_carpeta" id="nombre_carpeta">
                <a id="crear_carpeta" class="button secondary mod_carpeta">Aceptar</a>
                <a class="close-reveal-modal">&#215;</a>
            </div>
            <div id="mensaje_modificar_carpeta" class="reveal-modal medium" data-reveal>
                <h5>Modifica el nombre de la carpeta:</h5>
                <input type="text" name="nombre_carpeta" id="modifica_nombre_carpeta" value="">
                <a id="modificar_carpeta" class="button secondary mod_carpeta">Modificar</a>
                <a href="#" data-reveal-id="mensaje_borrar_carpeta" class="secondary button">Borrar</a>
                <a class="close-reveal-modal">&#215;</a>
            </div>
            <div id="mensaje_borrar_carpeta" class="reveal-modal medium" data-reveal>
                <h5>Borrado de la carpeta</h5>

                <p><i class="fa fa-warning"></i> Todos los documentos contenidos en esta carpeta también serán
                    borrados!!</p>
                <a id="cancelar_borrado" class="button secondary mod_carpeta">Cancelar</a>
                <a id="borrar_carpeta" class="button secondary mod_carpeta">Aceptar</a>
                <a class="close-reveal-modal">&#215;</a>
            </div>
        {% endif %}

        {#        {% for carpeta in carpetas %}#}
        {#            <div class="row" style="border-bottom: lightgrey 1px solid;" id="carpeta{{ carpeta.id }}">#}
        {#                <div class="columns large-1">#}
        {#                    <input type="checkbox" id="cb_carpeta{{ carpeta.id }}">#}
        {#                </div>#}
        {#                <div class="columns large-4">#}
        {#                    <a class="acceder_carpeta" data-id="{{ carpeta.id }}"><i#}
        {#                            class="fa fa-folder"></i> {{ carpeta.nombre }}</a>#}
        {#                </div>#}
        {#                <div class="columns large-3">#}
        {#                    {{ carpeta.modificado|date:"d/m/Y" }}#}
        {#                </div>#}
        {#                <div class="columns large-3">#}
        {#                    {% for accede in carpeta.permiso_ges_documental_set.all %}#}
        {#                        {{ accede.gauser.get_full_name }}#}
        {#                    {% endfor %}#}
        {#                </div>#}
        {#                <div class="columns large-1">#}
        {#                    <i class="fa fa-ellipsis-h"></i>#}
        {#                </div>#}
        {#            </div>#}
        {#        {% endfor %}#}
    </form>
    <div id="documentos_borrados" class="reveal-modal" data-reveal>
        <h3>Documentos borrados</h3>
        <ul id="ul_borrados"></ul>
        <a class="close-reveal-modal">&#215;</a>
    </div>

{% endblock %}

{% block final %}
    <script>
        habilita(['s_search',]);
        $('#search_sign').click(function (e) {
            e.preventDefault();
            if (!($(this).hasClass('disabled'))) {
                $.post("/documentos/", {action: 'ver_formulario_buscar'},
                    function (data) {
                        if (data.ok) {
                            $('#div_fieldsets').html(data.html);
                            $("#update_ok").show().delay(1500).fadeOut();
                        } else {
                            $("#update_error").show().delay(1500).fadeOut();
                        }
                    });
            }
        });

        $('body').on('click', '#busca_docs_manual', function (e) {
            e.preventDefault();
            $.post("/documentos/", {
                    action: 'busca_docs_manual',
                    inicio: $('#id_fecha_inicio').val(),
                    fin: $('#id_fecha_fin').val(),
                    texto: $('#busca_texto_doc').val(),
                    etiqueta: $('#etiqueta_busqueda').val()
                },
                function (data) {
                    if (data.ok) {
                        $("#tabla_archivos tbody").html(data.html);
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });

        $('body').on('click', '.descargar_doc', function (e) {
            e.preventDefault();
            $('#documento').val($(this).data('doc'));
            $('#action').val('descargar_doc');
            document.{{formname}}.submit();
        });

        {% if g_e|has_permiso:'sube_archivos' %}
            habilita(['s_plus',]);
            $('#plus_sign').click(function (e) {
                e.preventDefault();
                if (!($(this).hasClass('disabled'))) {
                    $.post("/documentos/", {action: 'ver_formulario_subir'},
                        function (data) {
                            if (data.ok) {
                                $('#div_fieldsets').html(data.html);
                                $("#update_ok").show().delay(1500).fadeOut();
                            } else {
                                $("#update_error").show().delay(1500).fadeOut();
                            }
                        });
                }
            });

            $('body').on('click', '#sube_archivo', function () {
                var input_files = document.getElementById('id_archivo').files;

                for (var i = 0; i < input_files.length; i++) {
                    console.log(input_files[i].name + ' (' + input_files[i].size + ' bytes)');
                }

                var formData = new FormData();
                for (var i = 0; i < input_files.length; i++) {
                    formData.append('fichero_xhr' + i, input_files[i]);
                }
                formData.append('n_files', input_files.length);
                formData.append('action', 'sube_archivo');
                formData.append('etiqueta', $('#select_etiqueta').val());
                formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
                var xhr = new XMLHttpRequest();
                {#xhr.upload.addEventListener("progress", updateProgress, false);#}
                xhr.onload = function () {
                    if (xhr.readyState === xhr.DONE) {
                        if (xhr.status === 200) {
                            console.log('Terminado');
                            var data = JSON.parse(xhr.responseText);
                            $("#tabla_archivos tbody").prepend(data.html);
                            if (data.mensaje) {
                                show_mensajes({title: 'Error', texto: data.mensaje})
                            }
                        }
                    }
                };
                xhr.open('POST', "/documentos/", true);
                xhr.send(formData);
            });
        {% endif %}

        {% if g_e|has_permiso:'crea_carpetas' %}
            habilita(['s_folder',]);
            $('#folder_sign').click(function (e) {
                e.preventDefault();
                if (!($(this).hasClass('disabled'))) {
                    $.post("/documentos/", {action: 'ver_formulario_crear_etiqueta'},
                        function (data) {
                            if (data.ok) {
                                $('#div_fieldsets').html(data.html);
                                $("#update_ok").show().delay(1500).fadeOut();
                            } else {
                                $("#update_error").show().delay(1500).fadeOut();
                            }
                        });
                }
            });

            $('body').on('click', '#crea_etiqueta', function (e) {
                e.preventDefault();
                $.post("/documentos/", {
                        action: 'crea_etiqueta',
                        nombre: $('#id_etiqueta_nueva').val(),
                        padre: $('#select_etiqueta_padre').val()
                    },
                    function (data) {
                        if (data.ok) {
                            $('#div_fieldsets').html('');
                            $("#update_ok").show().delay(1500).fadeOut();
                        } else {
                            $("#update_error").show().delay(1500).fadeOut();
                        }
                    });
            });
        {% endif %}


        $('body').on('click', '.borrar_doc', function (e) {
            e.preventDefault();
            $('#documento').val($(this).data('doc'));
            var texto = 'Si aceptas no tendrás acceso al documento. Si eres el propietario' +
                ' o tienes permisos suficientes podrías borrar completamente el documento de la base de datos.';
            show_mensajes({
                title: 'Eliminar el documento selecccionado', texto: texto, buttons: {
                    "Cancelar": function () {
                        hide_mensajes();
                    },
                    "Aceptar": function () {
                        hide_mensajes();
                        var doc = $('#documento').val();
                        $.post("/documentos/", {action: 'borrar_documento', doc: doc},
                            function (data) {
                                if (data.ok) {
                                    $('#fila' + doc).remove();
                                    $("#update_ok").show().delay(1500).fadeOut();
                                } else {
                                    $("#update_error").show().delay(1500).fadeOut();
                                }
                            });
                    }
                }
            });
        });

        {% if g_e|has_permiso:'borra_cualquier_archivo' %}
            $('body').on('click', '.borrar_doc_completamente', function (e) {
                e.preventDefault();
                $('#documento').val($(this).data('doc'));
                var texto = 'Si aceptas no tendrás acceso al documento. El documento se borrará completamente' +
                    ' de la base de datos. Nadie tendrá acceso a él.';
                show_mensajes({
                    title: 'Eliminar completamente el documento selecccionado', texto: texto, buttons: {
                        "Cancelar": function () {
                            hide_mensajes();
                        },
                        "Aceptar": function () {
                            hide_mensajes();
                            var doc = $('#documento').val();
                            $.post("/documentos/", {action: 'borrar_doc_completamente', doc: doc},
                                function (data) {
                                    if (data.ok) {
                                        $('#fila' + doc).remove();
                                        $("#update_ok").show().delay(1500).fadeOut();
                                    } else {
                                        $("#update_error").show().delay(1500).fadeOut();
                                    }
                                });
                        }
                    }
                });
            });
        {% endif %}

        $('body').on('click', '.editar_doc', function (e) {
            e.preventDefault();
            var doc = $(this).data('doc');
            $.post("/documentos/", {
                    action: 'ver_formulario_editar',
                    doc: doc
                },
                function (data) {
                    if (data.ok) {
                        $('#fila' + doc).html(data.html);
                        $('#action').val(doc);
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });

        $('body').on('click', '#update_archivo', function (e) {
            e.preventDefault();
            var action = 'update_archivo';
            var doc = $(this).data('doc');
            var nombre = $('#edit_nombre_archivo').val();
            var etiqueta = $('#edit_select_etiqueta').val();
            var cargos = $('#edit_select_cargos').val();
            var subs = $('#edit_select_subentidades').val();
            $.post("/documentos/", {
                    action: action, doc: doc, nombre: nombre, etiqueta: etiqueta, cargos: cargos, subs: subs
                },
                function (data) {
                    if (data.ok) {
                        $("#update_ok").show().delay(1500).fadeOut();
                        $('#fila' + doc).html(data.html);
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });
    </script>
{% endblock %}