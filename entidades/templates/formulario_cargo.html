{% load my_templatetags %}

<style>
    h4 {
        text-align: center;
        color: #008CBA;
    }

    .heading {
        color: #008cba;
        font-size: 0.85rem !important;
        font-weight: bold;
        text-transform: uppercase;
    }

    .heading_number {
        color: #008cba;
        font-size: 0.85rem !important;
        font-weight: bold;
        text-transform: uppercase;
        text-align: right;
    }
</style>
{% if request.session.gauser_extra|has_permiso:'borra_perfiles' %}
    <div class="row">
        <div class="large-9 medium-6 small-3 columns">
            &nbsp;
        </div>
        <div class="large-3 medium-6 small-9 columns" style="text-align: right;">
            <a class="button del_cargo" data-cargo="{{ cargo.id }}"><i class="fa fa-trash-o"></i> Borrar</a>
        </div>
    </div>
{% endif %}
<div class="row">
    <div class="large-7 columns">
        {% if request.session.gauser_extra|has_permiso:'edita_perfiles' %}
            <label>Define el cargo
                <input id="id_cargo" maxlength="200" name="cargo" value="{{ cargo.cargo }}" type="text"
                       data-cargo="{{ cargo.id }}">
            </label>
        {% else %}
            <label>Define el cargo
            </label>
            {{ cargo.cargo }}
        {% endif %}
    </div>
    <div class="large-4 columns">
        {% if request.session.gauser_extra|has_permiso:'edita_perfiles' %}
            <label title="El primer nivel es entendido como el cargo más alto">Nivel en el organigrama
                <select id="id_nivel" name="nivel" data-cargo="{{ cargo.id }}">
                    <option value="">---------</option>
                    <option value="1" {% if cargo.nivel == 1 %}selected="selected"{% endif %}>Cargo/Perfil de primer nivel</option>
                    <option value="2" {% if cargo.nivel == 2 %}selected="selected"{% endif %}>Cargo/Perfil de segundo nivel</option>
                    <option value="3" {% if cargo.nivel == 3 %}selected="selected"{% endif %}>Cargo/Perfil de tercer nivel</option>
                    <option value="4" {% if cargo.nivel == 4 %}selected="selected"{% endif %}>Cargo/Perfil de cuarto nivel</option>
                    <option value="5" {% if cargo.nivel == 5 %}selected="selected"{% endif %}>Cargo/Perfil de quinto nivel</option>
                    <option value="6" {% if cargo.nivel == 6 %}selected="selected"{% endif %}>Cargo/Perfil de sexto nivel</option>
                </select>
            </label>
        {% else %}
            <label title="El primer nivel es entendido como el cargo más alto">Nivel en el organigrama
            </label>
            {{ cargo.get_nivel_display }}
        {% endif %}
    </div>
    <div class="large-1 columns">
        <label title="Identificador para carga masiva">Id</label><strong>{{ cargo.id }}</strong>
    </div>
</div>
<div class="row">
    <div class="large-12 columns">
        <label>Personas con este Cargo/Perfil asignado
            {% if request.session.gauser_extra|has_permiso:'asigna_perfiles' %}
                <input type="hidden" name="usuarios_cargo" id="usuarios_cargo" data-cargo="{{ cargo.id }}" value="">
            {% else %}
                <span id="usuarios_perfil" style="font-weight: 800;"></span>
            {% endif %}
        </label>
    </div>
</div>


<div>
    <h5><i class="fa fa-hand-o-up" id="select_permisos"></i> <strong>Selecciona los permisos de este cargo</strong></h5>
</div>

{% with permisos=cargo.permisos.all %}
    {% for menu in entidad|menus %}
        <div class="row">
            <div class="columns large-1">&nbsp;</div>
            <div class="columns large-8 end nombre heading">{{ menu.pos }} {{ menu.texto_menu }}</div>
        </div>
        {% for p in menu.permisos %}
            <div class="row">
                <div class="columns large-2">&nbsp;</div>
                <div class="columns large-10">
                    <input type="checkbox" class="permiso_cargo" id="pc{{ p.id }}" data-cargo="{{ cargo.id }}"
                           value="{{ p.id }}" {% if p in permisos %}checked{% endif %}> {{ p.nombre }}
                </div>
            </div>
        {% endfor %}
        {% for m in menu.children %}
            <div id="child{{ m.id }}">
                <div class="row">
                    <div class="columns large-2">&nbsp;</div>
                    <div class="columns large-10 heading">{{ menu.pos }}.{{ m.pos }} {{ m.texto_menu }}</div>
                </div>
                {% for p in m.permisos %}
                    <div class="row">
                        <div class="columns large-3">
                            &nbsp;
                        </div>
                        <div class="columns large-9">
                            <input type="checkbox" class="permiso_cargo" data-cargo="{{ cargo.id }}" id="pc{{ p.id }}"
                                   value="{{ p.id }}" {% if p in permisos %}checked{% endif %}>
                            {{ p.nombre }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    {% endfor %}
{% endwith %}

<script>
    {% if gauser_extra|has_permiso:'borra_perfiles' %}
        $('#Contenido').on('click', '.del_cargo', function(e){
            e.preventDefault();
            var cargo = $(this).data('cargo');
            $.post("/organigrama/", {action: 'del_cargo', cargo: cargo}, function (data) {
                $('#accordion' + data).remove();
                $("#update_ok").show().delay(1500).fadeOut();
            });
        });
    {% endif %}

    {% if gauser_extra|has_permiso:'edita_perfiles' %}
        $('#Contenido').on('keyup', '#id_cargo', function () {
            var texto = $(this).val();
            var cargo = $(this).data('cargo');
            $.post("/organigrama/", {action: 'change_name_cargo', cargo: cargo, texto: texto}, function (data) {
                $('#span_cargo' + cargo).html(data);
                $("#update_ok").show().delay(1500).fadeOut();
            });
        });

        $('#Contenido').on('change', '#id_nivel', function () {
            var nivel = $(this).val();
            var cargo = $(this).data('cargo');
            $.post("/organigrama/", {action: 'change_nivel_cargo', cargo: cargo, nivel: nivel}, function (data) {
                $('#span_nivel' + cargo).html(data);
                $("#update_ok").show().delay(1500).fadeOut();
            });
        });
    {% endif %}

    {% if gauser_extra|has_permiso:'asigna_permisos' %}
        $('#Contenido').on('change', '.permiso_cargo', function () {
            var permiso = $(this).val();
            var cargo = $(this).data('cargo');
            if ($(this).is(':checked')) {
                var action = 'add_permiso';
            } else {
                var action = 'del_permiso';
            }
            $.post("/organigrama/", {permiso: permiso, action: action, cargo: cargo}, function (data) {
                $("#update_ok").show().delay(1500).fadeOut();
            }, 'json');
        });
    {% else %}
        $('.permiso_cargo').prop('disabled', true);
    {% endif %}

    {% if gauser_extra|has_permiso:'asigna_perfiles' %}
        $("#usuarios_cargo").select2({
            placeholder: "Escribe parte del nombre",
            minimumInputLength: 3,
            multiple: true,
            ajax: {
                url: "/buscar_usuarios/",
                dataType: 'json',
                quietMillis: 100,
                data: function (term, page) { // page is the one-based page number tracked by Select2
                    return {
                        action: 'select2',
                        q: term, //search term
                        page_limit: 10, // page size
                        page: page // page number
                    };
                },
                results: function (data) {
                    return {
                        results: $.map(data, function (item) {
                            return {
                                text: item.last_name + ', ' + item.first_name + ' (' + item.perfiles + ')',
                                id: item.id
                            }
                        })
                    };
                }
            },
            formatResult: function (resultado) {
                return '<div class="select2-user-result">' + resultado.text + '</div>';
            },
            formatSelection: function (resultado) {
                return resultado.text;
            },
            dropdownCssClass: "bigdrop", // apply css that makes the dropdown taller
            escapeMarkup: function (m) {
                return m;
            } // we do not want to escape markup since we are displaying html in results
        });
        var usuarios_cargo_iniciales = {% autoescape off %}{{usuarios}}{% endautoescape %};
        {% if usuarios %}
            $("#usuarios_cargo").select2("data", usuarios_cargo_iniciales);
        {% endif %}

        var usuarios_cargo_actuales = [];
        $.each(usuarios_cargo_iniciales, function (index, o) {
            usuarios_cargo_actuales.push('' + o.id); {# Esta suma se hace para convertir en string o.id #}
        });

        function diff(A, B) {
            return A.filter(function (a) {
                return B.indexOf(a) == -1;
            });
        }
        $("#usuarios_cargo").change(function () {
            var usuarios_cargo = $(this).val().split(',');
            var cargo = $(this).data('cargo');
            var removed = diff(usuarios_cargo_actuales, usuarios_cargo);
            var added = diff(usuarios_cargo, usuarios_cargo_actuales);
            usuarios_cargo_actuales = usuarios_cargo;
            $.post("/organigrama/", {action: 'update_usuarios_cargo', cargo: cargo, removed: removed, 'added': added},
                    function (data) {
                        if(data.ok){
                            $("#update_ok").show().delay(1500).fadeOut();
                        }else{
                            $("#update_error").show().delay(1500).fadeOut();
                        }

                    }, 'json');
        });

    {% else %}
        var usuarios = {% autoescape off %}{{usuarios}} {% endautoescape %};
        $('#usuarios_perfil').append('<br>&nbsp;&nbsp;');
        $.each(usuarios, function (index, o) {
            $('#usuarios_perfil').append(o.text + '; ');
        });

    {% endif %}


</script>