{% extends "base.html" %}

{% block head %}
    <style>
        label {
            font-weight: bold;
        }
    </style>
{% endblock %}
{% block contenido %}
    <form action="" method="post" enctype="multipart/form-data" id="{{ formname }}" name="{{ formname }}">
        {% csrf_token %}
        <input type="hidden" name="action" id="action" value="">

        <div class="">
            <h4 style="text-align: center;color: #008CBA;"><strong> Datos
                {% if request.session.gauser_extra.ronda.entidad.organization.id == 1 %}
                    del Grupo Scout
                {% elif request.session.gauser_extra.ronda.entidad.organization.id == 7 %}
                    del Centro de Estudios
                {% else %} {{ request.session.gauser_extra.ronda.entidad.de_la_entidad }}{% endif %}
                {{ request.session.gauser_extra.ronda.entidad.name }}</strong></h4>
        </div>

        <div class="row">
            <div class="large-4 columns">
                <label>Ronda o curso
                    <select name="ronda" id="id_ronda" data-campo="ronda" data-objeto="entidad">
                        {% for ronda in rondas %}
                            <option value="{{ ronda.id }}"
                                    {% if request.session.gauser_extra.ronda.entidad.ronda.id == ronda.id %}selected{% endif %}>{{ ronda.nombre }}</option>
                        {% endfor %}
                    </select>
                </label>
            </div>
            <div class="large-2 columns">
                <label>NIF {{ request.session.gauser_extra.ronda.entidad.de_la_entidad }}
                    {{ form.nif }}
                </label>
            </div>
            <div class="large-4 columns">
                <label>IBAN (Identificación bancaria)
                    {{ form.iban }}
                </label>
            </div>
            <div class="large-2 columns">
                <label>Subdominio
                    {{ form.dominio }}
                </label>
            </div>
        </div>
        <div class="row">
            <div class="large-4 columns">
                <label>Dirección {{ request.session.gauser_extra.ronda.entidad.de_la_entidad }}
                    {{ form.address }}
                </label>
            </div>
            <div class="large-2 columns">
                <label>Código postal
                    {{ form.postalcode }}
                </label>
            </div>
            <div class="large-3 columns">
                <label>Localidad
                    {{ form.localidad }}
                </label>
            </div>
            <div class="large-3 columns">
                <label>Provincia
{#                    <select class="selectable" ></select>#}
                    {{ form.provincia }}
                </label>
            </div>
        </div>
        <div class="row">
            <div class="large-4 columns">
                <label>Página web {{ request.session.gauser_extra.ronda.entidad.de_la_entidad }}
                    {{ form.web }}
                </label>
            </div>
            <div class="large-4 columns">
                <label>E-mail de contacto
                    {{ form.mail }}
                </label>
            </div>
            <div class="large-2 columns">
                <label>Teléfono
                    {{ form.tel }}
                </label>
            </div>
            <div class="large-2 columns">
                <label>Fax
                    {{ form.fax }}
                </label>
            </div>
        </div>
        <div class="row">
            <div class="large-6 columns">
                <label>Anagrama o logotipo {{ request.session.gauser_extra.ronda.entidad.de_la_entidad }}
                    <input id="file_anagrama" type="file" name="file_anagrama" style="position: fixed; top: -3000px">
                </label>
            </div>
            <div class="large-6 columns">
                {% if entidad.anagrama %}
                    <img id="image_anagrama"
                            {#                     src="/media/anagramas/{{ request.session.gauser_extra.ronda.entidad.code }}_anagrama.png">#}
                         src="{{ entidad.anagrama.url }}">
                {% else %}
                    <a id="image_anagrama">Click para cargar imagen</a>
                {% endif %}
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="columns large-12">
                <h3>Configuración de los documentos generados por GAUSS</h3>
            </div>
        </div>
        <div class="row">
            <div class="columns large-3">
                <label>Margen sup.
                <input type="text" data-campo="margintop" value="{{ entidad.docconfentidad.margintop }}"
                data-objeto="docconfentidad" class="campo_char"></label>
            </div>
            <div class="columns large-3">
                <label>Margen inf.
                <input type="text" data-campo="marginbottom" value="{{ entidad.docconfentidad.marginbottom }}"
                data-objeto="docconfentidad" class="campo_char"></label>
            </div>
            <div class="columns large-3">
                <label>Margen izq.
                <input type="text" data-campo="marginleft" value="{{ entidad.docconfentidad.marginleft }}"
                data-objeto="docconfentidad" class="campo_char"></label>
            </div>
            <div class="columns large-3">
                <label>Margen der.
                <input type="text" data-campo="marginright" value="{{ entidad.docconfentidad.marginright }}"
                data-objeto="docconfentidad" class="campo_char"></label>
            </div>
        </div>

        <div class="row">
            <div class="columns large-12">
                <label>Definir la cabecera de la página en los documentos</label>
                <div contenteditable="true" id="cabecera_html"
                     style="border: lightgrey solid 1px; padding:10px;">
                    {% autoescape off %}
                        {{ entidad.docconfentidad.header|default_if_none:"" }}
                    {% endautoescape %}
                </div>
            </div>
            <div class="columns large-12">
                <label>Definir el pie de página en los documentos</label>
                <div contenteditable="true" id="pie_html"
                     style="border: lightgrey solid 1px; padding:10px;">
                    {% autoescape off %}
                        {{ entidad.docconfentidad.footer|default_if_none:"" }}
                    {% endautoescape %}
                </div>
            </div>
        </div>

{% for docente in docentes %}
    {{ docente.gauser.get_full_name }}, clave: {{ docente.clave_ex }}, id: {{ docente.id }}
    <input type="checkbox" data-id="{{ docente.id }}" class="docente"> <br>
    {% endfor %}


    </form>
{% endblock %}


{% block final %}
    <script>
    $('.docente').on('click', function () {
       var id=$(this).data('id');
       $.post("/datos_entidad/", {action: 'borrar_ge', id: id},
                function (data) {
                    if (data.ok) {
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
    });


        $("#id_ronda").on('change', function () {
                $('#action').val('update_ronda');
                document
                    .{{formname}}.submit();
         });

        $('#id_iban').attr('title', '{{request.session.gauser_extra.ronda.entidad.banco.nombre}}');


        $('body').on('click', '#image_anagrama', function () {
            $('#file_anagrama').trigger('click');
            console.log('click imagen_anagrama');
        });


        $('#file_anagrama').change(function () {
            var data = sube_archivo({
                gauss_file: 'file_anagrama',
                action: 'imagen_anagrama',
                tipos: 'image/jpeg, image/png, image/gif',
                ajaxFuncion: '/datos_entidad/',
                data1: '',
                data2: '',
                onOk: function (data) {
                    $('#image_anagrama').attr('src', data);
                    hide_mensajes();
                }
            });
        });

        {# ------------------------------------------------- #}

        var cabecera_html = CKEDITOR.replace('cabecera_html');
        cabecera_html.config.allowedContent = true;
        cabecera_html.config.extraAllowedContent = '*(*)';
        var pie_html = CKEDITOR.replace('pie_html');
        pie_html.config.allowedContent = true;
        pie_html.config.extraAllowedContent = 'span';


        cabecera_html.on('change', function (e) {
            var header = cabecera_html.getData();
            $.post("/datos_entidad/", {action: 'update_cabecera_html', header: header},
                function (data) {
                    if (data.ok) {
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });

        pie_html.on('change', function (e) {
            var footer = pie_html.getData();
            $.post("/datos_entidad/", {action: 'update_pie_html', footer: footer},
                function (data) {
                    if (data.ok) {
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });

        {# ------------------------------------------------- #}

        function update_campo(){
            var valor=$(this).val();
            var campo=$(this).data('campo');
            var objeto=$(this).data('objeto');
            $.post("/datos_entidad/", {action: 'update_campo', valor: valor, campo: campo, objeto: objeto},
                function (data) {
                    if (data.ok) {
                        $("#update_ok").show().delay(1500).fadeOut();
                        if (data.mensaje){
                            show_mensajes({title:'Aviso', texto:data.mensaje})
                        }
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        }
        $('.campo_char').on('keyup', update_campo);
        $('.campo_select').on('change', update_campo);
    </script>
{% endblock %}