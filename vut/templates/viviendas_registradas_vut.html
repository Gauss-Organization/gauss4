{% extends "base.html" %}
{% load vut_extras %}

{% block head %}
    <style>
        table {
            display: block;
            overflow-x: auto;
            white-space: nowrap;
            width: 100%;
        }
    </style>
{% endblock %}

{% block contenido %}
    <form action="" method="post" enctype="multipart/form-data" id="{{ formname }}" name="{{ formname }}">
        {% csrf_token %}
        <input type="hidden" name="action" id="action" value="">
        <div>
            <h4 id="h4_title" style="text-align: center;color: #008CBA;"><strong> Viviendas de uso
                turístico registradas</strong></h4>
        </div>
        <table>
            <tbody>
            <tr>
                <th>Nº de socios</th>
                <th>Nº de propietarios</th>
                <th>Nº de viviendas</th>
                <th>Con Nº de registro</th>
            </tr>
            <tr>
                <td>{{ socios|length }}</td>
                <td>{{ num_propietarios }}</td>
                <td>{{ viviendas|length }}</td>
                <td>{{ viviendas|num_registradas }}</td>
            </tr>
            </tbody>
        </table>
        <table>
            <tbody>
            <tr>
                <th>Socio</th>
                <th>IBAN</th>
                <th>Viviendas</th>
            </tr>
            {% for s in socios %}
                <tr id="fila_socio{{ s.id }}">
                    {% if g_e|has_permiso_vut:"borra_viviendas_registradas" %}
                        <td title="Si haces click aquí se eliminarán las viviendas propiedad de este usuario"><a
                                class="borrar_viviendas_registradas" data-id="{{ s.id }}">{{ s.gauser.get_full_name }}
                            ({{ s|number_viviendas_same_propietario }})</a></td>
                    {% else %}
                        <td>{{ s.gauser.get_full_name }} ({{ s|number_viviendas_same_propietario }})</td>
                    {% endif %}
                    <td>{% if s.num_cuenta_bancaria|length > 20 %}<span class="label round">IBAN</span>
                        ****{{ s.num_cuenta_bancaria|slice:'20:' }}{% else %}
                        <span class="label round alert">IBAN no definido</span>{% endif %}
                    </td>
                    <td>
                        {% for v in s|viviendas_same_propietario %}
                            <p><i class="fa fa-home"></i> {{ v.nombre }} {% if v.nregistro %}
                                <span class="label round success">{{ v.nregistro }}</span> {% else %}&nbsp;
                                <span class="label round alert">Falta nº de registro</span> {% endif %}
                                {% for copropietario in v|copropietarios:s %}
                                    <small>- {{ copropietario.get_full_name }}</small>
                                {% endfor %}
                            </p>
                        {% endfor %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {#        {% for v in viviendas %}#}
        {#            {% ifchanged v.gpropietario %}#}
        {#                {% if not forloop.first %}#}
        {#                    <hr><p><b>{{ v.gpropietario.get_full_name }} ({{ v.gpropietario|number_viviendas_same_propietario }})</b>#}
        {#                    {% if v.gauser_extra.num_cuenta_bancaria|length > 20 %}<span class="label round">IBAN</span>#}
        {#                        ****{{ v.gauser_extra.num_cuenta_bancaria|slice:'20:' }}{% else %}#}
        {#                        <span class="label round alert">IBAN no definido</span>{% endif %}</p>#}
        {#                {% else %}#}
        {#                    <p><b>{{ v.gpropietario.get_full_name }} ({{ v.gpropietario|number_viviendas_same_propietario }})</b>#}
        {#                        {% if v.gauser_extra.num_cuenta_bancaria|length > 20 %}<span class="label round">IBAN</span>#}
        {#                            ****{{ v.gauser_extra.num_cuenta_bancaria|slice:'20:' }}{% else %}#}
        {#                            <span class="label round alert">IBAN no definido</span>{% endif %}</p>#}
        {#                {% endif %}#}
        {#            {% endifchanged %}#}
        {#            <i class="fa fa-home"></i> {{ v.nombre }} {% if v.nregistro %}(<span style="color:green;">{{ v.nregistro }}</span>) {% else %}&nbsp;(<span style="color:red;">Falta nº de registro</span>) {% endif %}#}
        {#        {% endfor %}#}

    </form>
    <div id="mensajes_asociados_page" style="display: none;">
        <span id="title0"><i class="fa fa-warning"></i> ¿Borrar viviendas/propietario?</span>
        <span id="texto0"><p>Si aceptas, esta persona dejará de ser propietario de la/s vivienda/s.</p>
            <p>Si fuera propietario único, la vivienda se eliminará.</p></span>
        <span id="title1"><i class="fa fa-info-circle"></i> Propietario/a borrado/a</span>
        <span id="texto1"><p>Recuerda que el usuario no ha sido borrado de GAUSS.</p>
        <p>El borrado completo del usuario debe hacers a través del procedimiento habitual y se deben tener los permisos
            necesarios.</p></span>
        <span id="title2"><i class="fa fa-info-circle"></i> Propietario/a <b>no</b> borrado/a</span>
        <span id="texto2"><p>Ha ocurrido un error y no se ha podido borrar al propietario.</p>
        <p>Contacta con el administrador del sistema si el problema persiste.</p></span>
    </div>


{% endblock %}

{% block final %}
    <script>
        {% if request.session.gauser_extra|has_permiso_vut:'borra_viviendas_registradas' %}
            $('body').on('click', '.borrar_viviendas_registradas', function (e) {
                e.preventDefault();
                usuario = $(this).data('id');
                show_mensajes({
                    title: $('#title0').html(),
                    texto: $('#texto0').html(),
                    buttons: {
                        "Cancelar": function () {
                            hide_mensajes();
                        },
                        "Aceptar": function () {
                            hide_mensajes();
                            $.post("/viviendas_registradas_vut/", {
                                    action: 'borrar_viviendas_registradas',
                                    usuario: usuario
                                },
                                function (data) {
                                    if (data.ok) {
                                        $("#update_ok").show().delay(1500).fadeOut();
                                        $('#fila_socio' + usuario).remove();
                                        setTimeout(function () {
                                            show_mensajes({
                                                title: $('#title1').html(),
                                                texto: $('#texto1').html()
                                            });
                                        }, 600);
                                    } else {
                                        $("#update_error").show().delay(1500).fadeOut();
                                        setTimeout(function () {
                                            show_mensajes({
                                                title: $('#title2').html(),
                                                texto: $('#texto2').html()
                                            });
                                        }, 600);
                                    }
                                });
                        }
                    }
                });
            });
        {% endif %}

        $('body').on('click', '.borrar_viviendas_registradas', function () {
            var usuario = $(this).data('id');
            $.post("/viviendas_registradas_vut/", {
                    action: 'borrar_viviendas_registradas',
                    usuario: usuario
                },
                function (data) {
                    if (data.ok) {
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $('#update_error').show().delay(1500).fadeOut();
                    }
                }, 'json');
        });

    </script>
{% endblock %}