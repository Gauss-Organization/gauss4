{% extends "base_select2-4.html" %}
{% load my_templatetags %}

{% block contenido %}
    <form action="" method="post" enctype="multipart/form-data" id="{{ formname }}" name="{{ formname }}">
        {% csrf_token %}

        <div class="">
            <h4 style="text-align: center;color: #008CBA;"><strong> Configuración de Competencias/Evaluación</strong>
            </h4>
        </div>
        <ul class="tabs" data-tab role="tablist">
            <li class="tab-title active"><a href="#tab1" style="font-weight: bold;">Competencias Clave y DOs</a></li>
            <li class="tab-title"><a href="#tab2" style="font-weight: bold;">Áreas, Comp. Espec. y Crit. de Eval.</a>
            </li>
        </ul>
        <div class="tabs-content">
            <div class="content active" id="tab1">
                <dl class="accordion" data-accordion id="list_ce_dos">
                    {% for ps in pss %}
                        <dd class="accordion-navigation" id="accordion_ce_dos{{ ps.id }}"
                            style="border-bottom: dotted 1px black">
                            <a href="#panel_ce_dos{{ ps.id }}">
                                <i id="circle_ce_dos{{ ps.id }}" class="fa fa-plus-circle circle_icon"></i>
                                <span style="font-weight: bold;">{{ ps }}</span>
                            </a>
                            <div id="panel_ce_dos{{ ps.id }}" class="content accordion-ps" data-tipo="ce_dos"
                                 data-id="{{ ps.id }}"></div>
                        </dd>
                    {% endfor %}
                </dl>
            </div>
            <div class="content" id="tab2">
                <dl class="accordion" data-accordion>
                    {% for ps in pss %}
                        <dd class="accordion-navigation" id="accordion_am_ce_cev{{ ps.id }}"
                            style="border-bottom: dotted 1px black">
                            <a href="#panel_am_ce_cev{{ ps.id }}">
                                <i id="circle_am_ce_cev{{ ps.id }}" class="fa fa-plus-circle circle_icon"></i>
                                <span style="color:#008CBA">Áreas/Materias, Competencias Específicas y Criterios de Evaluación:</span> {{ ps }}
                            </a>
                            {#                        <dd class="accordion-navigation">#}
                            {#                            <a href="#panelps{{ forloop.counter }}" style="font-weight: bold;">#}
                            {#                                <span style="color:#008CBA">Áreas/Materias, Competencias Específicas y Criterios de Evaluación:</span> {{ ps }}#}
                            {#                            </a>#}
                            <div id="panel_am_ce_cev{{ ps.id }}" class="content accordion-ps" data-tipo="am_ce_cev"
                                 data-id="{{ ps.id }}"></div>
                        </dd>
                    {% endfor %}
                </dl>
            </div>
        </div>
        <div id="div_reveal_inserta_ceval" class="reveal-modal" data-reveal>
            <input type="hidden" value="" id="id_cesp">
            <div class="row">
                <div class="columns large-12"><h3>Añadir Criterio de evaluación</h3></div>
            </div>
            <div class="row">
                <div class="columns large-6">
                    <label>Ciclo/Etapa
                        <select id="ciclo_ceval">
                            <option value="">----</option>
                            <option value="PRI1">Primer Ciclo Primaria</option>
                            <option value="PRI2">Segundo Ciclo Primaria</option>
                            <option value="PRI3">Tercer Ciclo Primaria</option>
                            <option value="SEC1">1º - 3º de ESO</option>
                            <option value="SEC3">1º - 4º de ESO</option>
                            <option value="SEC4">1º - 2º de ESO</option>
                            <option value="SEC5">3º - 4º de ESO</option>
                            <option value="SEC2">4º de ESO</option>
                            <option value="BAC">Bachillerato</option>
                        </select>
                    </label>
                </div>
                <div class="columns large-6"><label>Materia (opcional)
                    <input type="text" value="" id="materia_ceval"></label>
                </div>
            </div>
            <div class="row">
                <div class="columns large-2"><label>Orden
                    <input type="number" value="" id="orden_ceval"></label>
                </div>
                <div class="columns large-10"><label>Texto del criterio de evaluación
                    <input type="text" value="" id="texto_ceval"></label>
                </div>
            </div>
            <a class="close-reveal-modal reveal_modal_aviso">&#215;</a>
            <div class="row">
                <br>
                <div class="columns large-12"><a id="inserta_ceval"
                                                 class="button secondary">Aceptar</a>
                </div>
            </div>
        </div>
    </form>
{% endblock %}

{% block final %}
    <script>
        {# ########################################################### #}
        setTimeout(function () {
            $(document).foundation({
                accordion: {
                    callback: function (accordion) {
                        if (accordion.hasClass('accordion-ps')) {
                            var id = accordion.data('id');
                            var tipo = accordion.data('tipo');
                            var circle = $('#circle_' + tipo + id);
                            var panel = $('#panel_' + tipo + id);
                            if (circle.hasClass('fa-plus-circle')) {
                                $('.circle_icon').removeClass('fa-minus-circle').addClass('fa-plus-circle');
                                circle.removeClass('fa-plus-circle').addClass('fa-minus-circle');
                                window.scrollTo(0, $('#accordion_' + tipo + id).offset().top - 50);
                                $.post("/configura_competencias/", {action: 'open_accordion', id: id, tipo: tipo},
                                    function (data) {
                                        if (data.ok) {
                                            panel.html(data.html);
                                            $('.dos_select2').select2();
                                            $('.select2-container').css('width', '100%');
                                            $("#update_ok").show().delay(1500).fadeOut();
                                        } else {
                                            $("#update_error").show().delay(1500).fadeOut();
                                        }
                                    });
                            } else {
                                circle.removeClass('fa-minus-circle').addClass('fa-plus-circle');
                                panel.html('');
                            }
                        }
                    }
                }
            });
        }, 400);

        {# ########################################################### #}
        setTimeout(function () {
            $('.dos_select2').select2();
            $('.select2-container').css('width', '100%');
        }, 1200);

        {% if request.session.gauser_extra|has_permiso:'puede_configurar_competencias' %}

        $('body').on('change', '.dos_select2', function () {
            var dos = $(this).val();
            var cesp = $(this).data('cesp');
            $.post("/configura_competencias/", {
                    action: 'inserta_cesp_dos',
                    cesp: cesp,
                    dos: dos
                },
                function (data) {
                    if (data.ok) {
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });

        $('body').on('click', '#inserta_ceval', function () {
            var cesp = $('#id_cesp').val();
            var ciclo = $('#ciclo_ceval').val();
            var materia = $('#materia_ceval').val();
            var orden = $('#orden_ceval').val();
            var texto = $('#texto_ceval').val();
            $.post("/configura_competencias/", {
                    action: 'inserta_ceval',
                    cesp: cesp,
                    orden: orden,
                    ciclo: ciclo,
                    materia: materia,
                    texto: texto
                },
                function (data) {
                    if (data.ok) {
                        $('#list_ceval' + data.cesp).append(data.html);
                        $('#ciclo_ceval').val('');
                        $('#materia_ceval').val('');
                        $('#orden_ceval').val('');
                        $('#texto_ceval').val('');
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });
        $('body').on('click', '.reveal_inserta_ceval', function () {
            var cesp = $(this).data('cesp');
            $('#id_cesp').val(cesp);
            $('#div_reveal_inserta_ceval').foundation('reveal', 'open');
        });

        $('body').on('click', '.inserta_cesp', function () {
            var am = $(this).data('am');
            var orden = $('#cesp_orden' + am).val();
            var nombre = $('#cesp_nombre' + am).val();
            var texto = $('#cesp_texto' + am).val();
            $.post("/configura_competencias/", {
                    action: 'inserta_cesp',
                    am: am,
                    orden: orden,
                    nombre: nombre,
                    texto: texto
                },
                function (data) {
                    if (data.ok) {
                        $('#list_cesp' + data.am).append(data.html);
                        $('#cesp_orden' + data.am).val('');
                        $('#cesp_nombre' + data.am).val('');
                        $('#cesp_texto' + data.am).val('');
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });

        $('body').on('click', '.inserta_am', function () {
            var ps = $(this).data('ps');
            var nombre = $('#am_nombre' + ps).val();
            var texto = $('#am_texto' + ps).val();
            $.post("/configura_competencias/", {
                    action: 'inserta_am',
                    ps: ps,
                    nombre: nombre,
                    texto: texto
                },
                function (data) {
                    if (data.ok) {
                        $('#list_am' + data.ps).append(data.html);
                        $('#am_nombre' + data.ps).val('');
                        $('#am_texto' + data.ps).val('');
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });

        $('body').on('click', '.inserta_do', function () {
            var cc = $(this).data('cc');
            var clave = $('#do_clave' + cc).val();
            var texto = $('#do_texto' + cc).val();
            $.post("/configura_competencias/", {action: 'inserta_do', cc: cc, clave: clave, texto: texto},
                function (data) {
                    if (data.ok) {
                        $('#list_do' + data.cc).append(data.html);
                        $('#do_clave' + data.cc).val('');
                        $('#do_texto' + data.cc).val('');
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });

        $('body').on('click', '.inserta_cc', function () {
            var ps = $(this).data('ps');
            var orden = $('#cc_orden' + ps).val();
            var siglas = $('#cc_siglas' + ps).val();
            var competencia = $('#cc_competencia' + ps).val();
            var texto = $('#cc_texto' + ps).val();
            $.post("/configura_competencias/", {
                    action: 'inserta_cc',
                    ps: ps,
                    orden: orden,
                    siglas: siglas,
                    competencia: competencia,
                    texto: texto
                },
                function (data) {
                    if (data.ok) {
                        $('#list_cc' + data.ps).append(data.html);
                        $('#cc_orden' + data.ps).val('');
                        $('#cc_siglas' + data.ps).val('');
                        $('#cc_competencia' + data.ps).val('');
                        $('#cc_texto' + data.ps).val('');
                        $("#update_ok").show().delay(1500).fadeOut();
                    } else {
                        $("#update_error").show().delay(1500).fadeOut();
                    }
                });
        });
        {% endif %}
        {#$(document).foundation({#}
        {#    accordion: {#}
        {#        callback: function (accordion) {#}
        {#            if (accordion.hasClass('curso_pendientes')) {#}
        {#                var id = accordion.data('curso');#}
        {#                console.log(id);#}
        {#                if ($('#circle' + id).hasClass('fa-plus-circle')) {#}
        {#                    $('.circle_icon').removeClass('fa-minus-circle').addClass('fa-plus-circle');#}
        {#                    $('#circle' + id).removeClass('fa-plus-circle').addClass('fa-minus-circle');#}
        {#                    window.scrollTo(0, $('#accordion' + id).offset().top - 50);#}
        {#                    $.post("/configura_materias_pendientes/", {action: 'open_accordion', id: id},#}
        {#                        function (data) {#}
        {#                            if (data.ok) {#}
        {#                                $('#curso' + id).html(data.html);#}
        {#                                $("#update_ok").show().delay(1500).fadeOut();#}
        {#                            } else {#}
        {#                                $("#update_error").show().delay(1500).fadeOut();#}
        {#                            }#}
        {#                        });#}
        {#                } else {#}
        {#                    $('#circle' + id).removeClass('fa-minus-circle').addClass('fa-plus-circle');#}
        {#                    $('#curso' + id).html('');#}
        {#                }#}
        {#            }#}
        {#        }#}
        {#    }#}
        {# });#}
    </script>
{% endblock %}